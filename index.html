<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three.js GLTF/GLB Viewer</title>
  <style>
    html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; }
    canvas { width: 100%; height: 100%; display: block; }
    
    /* Landing Overlay (Matches your image) */
    #landing-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: #121212;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        color: #888;
    }

    .drop-box {
        width: 400px;
        height: 150px;
        background: #1e1e1e;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 20px;
        border: 2px dashed transparent;
        transition: border 0.3s ease;
    }

    /* Visual feedback when dragging over the window */
    body.drag-active .drop-box {
        border-color: #1a73e8;
        color: #1a73e8;
    }

    .choose-file-btn {
        background: transparent;
        color: #888;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
    }
    .choose-file-btn:hover { color: #fff; }

    /* Controls Panel (Hidden until model loads) */
    .controls-panel {
        position: absolute; 
        top: 15px; right: 15px;
        z-index: 10;
        display: none; /* Hidden initially */
        flex-direction: column; 
        gap: 10px;
        align-items: flex-end;
        background: rgba(255, 255, 255, 0.9); 
        padding: 15px;
        border-radius: 8px; 
    }

    .anim-section { display: none; flex-direction: column; gap: 5px; border-top: 1px solid #ccc; padding-top: 10px; text-align: right; }
    select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    label { font-size: 11px; color: #555; font-weight: bold; }
  </style>
</head>
<body>

<div id="landing-overlay">
    <div class="drop-box">
        Drag glTF 2.0 file here
    </div>
    <button class="choose-file-btn" onclick="document.getElementById('fileInput').click()">
        <span>â¬†</span> Choose file
    </button>
</div>

<div class="controls-panel" id="uiPanel">
  <button style="padding: 8px 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">Upload New</button>
  
  <div id="animContainer" class="anim-section">
    <label for="animSelect">ANIMATIONS</label>
    <select id="animSelect">
      <option value="-1">Static Pose</option>
    </select>
  </div>
</div>

<input type="file" id="fileInput" accept=".glb,.gltf" style="display:none" />

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

let scene, camera, renderer, controls, loader, mixer, currentModel;
let animations = [];
const clock = new THREE.Clock();

const landing = document.getElementById('landing-overlay');
const uiPanel = document.getElementById('uiPanel');
const animSelect = document.getElementById('animSelect');
const animContainer = document.getElementById('animContainer');

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x121212);

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

    camera.position.set(0, 1.5, 12);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    document.body.appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Ensure the camera is looking at the center of the scene (or slightly below)
    controls.target.set(0, 1.5, 0); 
    controls.update(); // Required after manually changing camera/target

    scene.add(new THREE.AmbientLight(0xffffff, 1.5));
    const light = new THREE.DirectionalLight(0xffffff, 2);
    light.position.set(5, 10, 7.5);
    scene.add(light);

    loader = new GLTFLoader();

    // Drag and Drop Events
    window.addEventListener('dragover', (e) => {
        e.preventDefault();
        document.body.classList.add('drag-active');
    });

    window.addEventListener('dragleave', () => {
        document.body.classList.remove('drag-active');
    });

    window.addEventListener('drop', (e) => {
        e.preventDefault();
        document.body.classList.remove('drag-active');
        const file = e.dataTransfer.files[0];
        if (file) loadUserGLB(file);
    });

    window.addEventListener('resize', onWindowResize);
}

function loadUserGLB(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        if (currentModel) scene.remove(currentModel);
        if (mixer) mixer.stopAllAction();

        loader.parse(e.target.result, '', (gltf) => {
            currentModel = gltf.scene;
            animations = gltf.animations;
            scene.add(currentModel);

            // Hide landing and show UI
            landing.style.display = 'none';
            uiPanel.style.display = 'flex';

            // Center and scale model automatically
            const box = new THREE.Box3().setFromObject(currentModel);
            const center = box.getCenter(new THREE.Vector3());
            currentModel.position.sub(center);
            controls.target.set(0, 0, 0);

            // Animation Setup
            animSelect.innerHTML = '<option value="-1">Static Pose</option>';
            if (animations.length > 0) {
                mixer = new THREE.AnimationMixer(currentModel);
                animContainer.style.display = 'flex';
                animations.forEach((clip, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerHTML = clip.name || `Anim ${i+1}`;
                    animSelect.appendChild(opt);
                });
                playAnimation(0);
                animSelect.value = 0;
            } else {
                animContainer.style.display = 'none';
            }
        });
    };
    reader.readAsArrayBuffer(file);
}

function playAnimation(index) {
    if (!mixer) return;
    mixer.stopAllAction();
    if (index !== -1) mixer.clipAction(animations[index]).play();
}

animSelect.onchange = (e) => playAnimation(parseInt(e.target.value));
document.getElementById("fileInput").onchange = (e) => e.target.files[0] && loadUserGLB(e.target.files[0]);

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    if (mixer) mixer.update(clock.getDelta());
    controls.update();
    renderer.render(scene, camera);
}
</script>
</body>
</html>
